# 메모리 관리

1. 참조 타입과 Heap

ARC : 메모리 영역 중 힙 영역을 관리

참조 타입 : 원본이 한개가 있으면 그 하나를 가지고 여러곳에서 같이 사용(calss, func, closure 등등)

Swift는 참조 타입을 자동으로 Heap에 할당 한다.

```swift
class Human {
    var name: String?
    var age: Int?
    
    init(name: String?, age: Int?) {
        self.name = name
        self.age = age
    }
}
 
let Han = Human(name: "han", age: 16) // 지역 변수
```

지역 변수 Han은 Stack에 할당

실제 Human 인스턴스는 Heap에 할당

스택에 있는 Han은 힙 영역에 있는 **인스턴스를** **참조하고 있는 형태**

Han 안엔 Heap에 할당된 인스턴스의 주소값이 들어있음

Heap의 특징 중 **사용하고 난 후에는 반드시 메모리 해제를 해줘야 한다.** 라는 특징이 있다.

메모리를 해제하기 위해선 release, free 등등의 방법이 있다.

하지만 저런 함수들을 통해 인스턴스를 직접 메모리에서 해제해 준 적은 없음 → **ARC가 자동으로 해제 해준다.**

---

ARC : **클래스 인스턴스가 더 이상 필요하지 않을 때 Heap에 할당된 메모리를 자동으로 해제한다.**

Heap영역에 메모리를 관리하는 방법

- GC
    
    참조 계산 시점 : Run Time(어플 실행 동안 주기적으로 참조를 추적하여 사용하지 않는 인스턴스를 해제함
    
    장점 : 인스턴스가 해제될 확률이 높음
    
    단점 : 개발자가 참조 해제 시점을 파악할 수 없다,
    
    Run Time 시점에 계속 추적하는 추가 리소스가 필요하여 성능저하가 발생할 수 있음
    
- RC
    
    참조 계산 시점 : Compile Time(컴파일 시점에 언제 참조되고 해제되는지 결정되어 런타임 때 그대로 실행됨
    
    장점 : 개발자가 참조 해제 시점을 파악할 수 있다 
    
    Run Time 시점에 추가 리소스가 발생하지 않는다.
    
    단점 : 순환 참조가 발생 시 영구적으로 메모리가 해제되지 않을 수 있다.
    

둘의 가장 큰 차이점은 **참조를 계산하는 시점**이다.

---

ARC의 메모리 관리 법

RC(Reference Count)를 사용

메모리의 참조 횟수(RC)를 계산하여, 참조 횟수가 0이 되면 더 이상 사용하지 않는 메모리라 생각하여 해제함.

**모든 인스턴스는 자신의 RC 값을 가지고 있다.**

RC를 세는 법

- RC 증가
    1. 인스턴스를 새로 생성할 때.
    2. 기존 인스턴스를 다른 변수에 대입할 때
- RC 감소
    1. 인스턴스를 가리키던 변수가 메모리에서 해제되었을 때
    2. nil이 저장되었을 때
    3. 변수에 다른 값을 대입한 경우
    4. 프로퍼티의 경우, 속해 있는 클래스 인스턴스가 메모리에서 해제될 때